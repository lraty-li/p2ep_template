# 字体系统技术文档

## 概述

本文档详细说明了 Persona 2 EP 字体系统的工作原理，包括字符编码、字体图片生成和映射关系。

## 1. 字符编码系统

### 1.1 字符编码格式

游戏使用 `0xPPYX` 格式的字符编码：
- `P` = 页码（高8位，0-31）
- `Y` = Y坐标（中间4位，0-15）
- `X` = X坐标（低4位，0-15）

### 1.2 字符编码计算

字符编码值通过以下公式计算：

```
编码值 = X + 16 * (Y + 16 * 页码)
```

其中：
- `页码` = font.json 中的页码键（0, 1, 2, ...）
- `Y` = 在16x16网格中的行索引（0-15）
- `X` = 在16x16网格中的列索引（0-15）

### 1.3 字符编码范围

每个页码对应 256 个编码位置：
- 页码0：编码范围 `0x0000 - 0x00FF`（0-255）
- 页码1：编码范围 `0x0100 - 0x01FF`（256-511）
- 页码2：编码范围 `0x0200 - 0x02FF`（512-767）
- ...
- 页码31：编码范围 `0x1F00 - 0x1FFF`（7936-8191）

## 2. font.json 结构

### 2.1 文件格式

`font.json` 是一个 JSON 对象，结构如下：

```json
{
  "页码": [
    [16个字符],  // 第0行
    [16个字符],  // 第1行
    ...
    [16个字符]   // 第15行（共16行）
  ]
}
```

### 2.2 示例

```json
{
  "0": [
    [" ", "、", "。", ",", ".", "・", ":", ";", "?", "!", "゛", "゜", "´", "`", "¨", "^"],
    ["￣", "_", "ヽ", "ヾ", "ゝ", "ゞ", "〃", "仝", "々", "〆", "〇", "ー", "―", "-", "/", "\\"],
    ...
  ],
  "1": [
    ["", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o"],
    ...
  ]
}
```

### 2.3 空字符串处理

- 空字符串 `""` 表示该位置未被使用或未定义字符
- 渲染时会跳过空字符位置

## 3. 字体图片系统

### 3.1 图片规格

- **图片尺寸**：256x256 像素
- **字符网格**：16x16 网格
- **字符大小**：每个字符 16x16 像素
- **格式**：PNG，RGBA（透明背景）

### 3.2 字符布局

每个字体图片包含 256 个字符位置（16行 × 16列），字符按以下方式排列：

```
位置 (0,0)  位置 (1,0)  ...  位置 (15,0)
位置 (0,1)  位置 (1,1)  ...  位置 (15,1)
...
位置 (0,15) 位置 (1,15) ...  位置 (15,15)
```

### 3.3 页码与图片文件映射

- `font0.png` → 页码0 → `5.gim`
- `font1.png` → 页码1 → `6.gim`
- `font2.png` → 页码2 → `7.gim`
- ...
- `font31.png` → 页码31 → `36.gim`

**映射规则**：页码 P 对应 `(5+P).gim`

## 4. 字符高度

### 4.1 固定高度

**重要**：所有字符的高度都是固定的，不存储在 JSON 文件中。

### 4.2 高度值

在 `eboot/asm/vwf.js` 的 `mapTextureFix` 函数中，高度被硬编码为：

```javascript
lui(tmp, 0x4180); //height, 16.0
```

- **高度值**：16.0（浮点数）
- **十六进制**：`0x4180`
- **所有字符共享相同高度**

### 4.3 水平信息

`font_info.json` 只存储水平信息：
- `left`：左边距（像素）
- `width`：字符宽度（像素）

## 5. font0 和 font1 的关系

### 5.1 页码索引

`font.json` 中的 `"0"` 和 `"1"` 是**页码索引**，不是直接对应 `font0.png` 和 `font1.png`。

### 5.2 字符编码映射

- 页码0的字符：编码值 0-255，Y坐标 0-255
- 页码1的字符：编码值 256-511，Y坐标 256-511（通过代码中 `addiu(y, y, 256)` 实现）

### 5.3 渲染时的处理

在 `vwf.js` 的 `mapTextureFix` 函数中：
- 提取页码：`srl($t4, $v1, 8)`
- 当页码不为0时，Y坐标加256：`addiu(y, y, 256)`

这允许页码1的字符通过Y坐标偏移访问，可能：
- 被合并到同一个纹理图集中，或
- 游戏动态切换纹理

## 6. 字体图片生成

### 6.1 生成脚本

使用 `generate_font_images.py` 脚本从字体文件生成图片：

```bash
cd font
python generate_font_images.py
```

### 6.2 生成过程

1. 读取 `locale/font.json` 获取字符布局
2. 加载字体文件（如 `fusion-pixel-10px-monospaced-zh_hans.otf`）
3. 对每个页码：
   - 创建 256x256 像素的图片
   - 遍历 16x16 网格
   - 渲染每个字符到对应位置（16x16像素）
   - 字符居中显示
   - 跳过空字符位置
4. 保存为 `font{页码}.png`

### 6.3 字符渲染

- 字符颜色：白色（255, 255, 255）
- 背景：透明（0, 0, 0, 0）
- 字符在16x16格子中居中显示
- 如果字体不支持某个字符，该位置留空

## 7. files.json 配置

### 7.1 文件映射

`files.json` 定义了字体图片与游戏资源文件的映射关系：

```json
{
  "path": "/PSP_GAME/USRDIR/pack/P2PT_ALL.cpk$/syscg.bin$",
  "files": {
    "font0.png": [
      {
        "path": "5.gim$/image.png",
        "args": { "useSourcePalette": true, "matchPalette": true }
      }
    ],
    ...
  }
}
```

### 7.2 映射规则

- `font{页码}.png` → `{5+页码}.gim$/image.png`
- 例如：`font2.png` → `7.gim$/image.png`

## 8. 中文化注意事项

### 8.1 需要生成的图片

中文化需要生成页码2-31的字体图片（共30个文件），因为：
- 页码0-1：通常包含基本字符（英文、数字、标点）
- 页码2-31：包含中文字符和其他扩展字符

### 8.2 字符布局

确保 `font.json` 中正确配置了中文字符的位置，字符必须：
- 按照16x16网格排列
- 每个位置对应一个字符编码值
- 空位置使用空字符串 `""`

### 8.3 字体选择

选择合适的中文字体文件：
- 像素字体（如 `fusion-pixel-10px-monospaced-zh_hans.otf`）
- 16x16像素大小
- 支持所需的中文字符集

## 9. 总结

### 9.1 关键概念

1. **字符编码**：`编码值 = X + 16 * (Y + 16 * 页码)`
2. **页码映射**：页码 P → `(5+P).gim` → `font{P}.png`
3. **固定高度**：所有字符高度为 16.0（硬编码）
4. **水平信息**：存储在 `font_info.json`（left, width）
5. **图片规格**：256x256像素，16x16字符网格

### 9.2 工作流程

1. 编辑 `locale/font.json` 定义字符布局
2. 运行 `generate_font_images.py` 生成字体图片
3. 更新 `files.json` 添加图片映射
4. 生成 `font_info.json` 定义字符宽度信息（使用工具）
5. 打包资源文件

---

**文档版本**：1.0  
**最后更新**：2024

